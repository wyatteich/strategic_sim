<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STRATEGIC CRISIS SIMULATION</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #ffb000;
            padding: 0;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .metrics-ribbon {
            background: #001a33;
            border-bottom: 2px solid #4a9eff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .metric-label {
            font-size: 9px;
            color: #6bb3ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffb000;
            margin-top: 3px;
        }
        
        .metric-bar {
            width: 80px;
            height: 4px;
            background: #1a2633;
            margin-top: 5px;
            border: 1px solid #2a5580;
        }
        
        .metric-bar-fill {
            height: 100%;
            background: #4a9eff;
            transition: width 0.3s ease;
        }
        
        .defcon-indicator {
            font-size: 14px;
            padding: 5px 15px;
            border: 1px solid #4a9eff;
            background: #1a2633;
        }
        
        .tab-navigation {
            background: #001a33;
            border-bottom: 1px solid #4a9eff;
            display: flex;
            padding: 0 20px;
            flex-shrink: 0;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6bb3ff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
        }
        
        .tab-btn:hover {
            color: #ffb000;
            background: rgba(74, 158, 255, 0.1);
        }
        
        .tab-btn.active {
            color: #ffb000;
            border-bottom-color: #4a9eff;
            background: rgba(74, 158, 255, 0.05);
        }
        
        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .header {
            border: 2px solid #4a9eff;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            background: #001a33;
        }
        
        .header h1 {
            font-size: 24px;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        
        .classified {
            color: #ff0000;
            font-size: 12px;
            letter-spacing: 2px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            border: 1px solid #4a9eff;
            padding: 15px;
            background: #001a33;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #4a9eff;
        }
        
        .situation-report {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid #ffb000;
            background: #1a2633;
        }
        
        .crisis-level {
            display: inline-block;
            padding: 2px 8px;
            margin-left: 10px;
            font-size: 11px;
        }
        
        .level-1 { background: #1a3d5c; color: #4a9eff; }
        .level-2 { background: #3d3d1a; color: #ffff00; }
        .level-3 { background: #3d2d1a; color: #ffaa00; }
        .level-4 { background: #3d1a1a; color: #ff0000; }
        .level-5 { background: #ff0000; color: #ffffff; animation: blink 1s infinite; }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat {
            padding: 8px;
            background: #1a2633;
            border-left: 2px solid #4a9eff;
        }
        
        .stat-label {
            font-size: 11px;
            color: #6bb3ff;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .options {
            margin-top: 20px;
        }
        
        .option-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #1a2633;
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .option-btn:hover {
            background: #2a4066;
            border-color: #6bb3ff;
            box-shadow: 0 0 10px #4a9eff;
        }
        
        .option-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .intel-feed {
            height: 300px;
            overflow-y: auto;
            background: #000a14;
            padding: 10px;
            font-size: 12px;
            border: 1px solid #2a5580;
        }
        
        .intel-item {
            margin-bottom: 10px;
            padding: 5px;
            border-left: 2px solid #4a9eff;
            padding-left: 8px;
        }
        
        .intel-timestamp {
            color: #6bb3ff;
            font-size: 10px;
        }
        
        .warning {
            color: #ff6600;
        }
        
        .critical {
            color: #ff0000;
            font-weight: bold;
        }
        
        .map-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #4a9eff;
            background: #001a33;
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000; }
        }
        
        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000000;
            border: 3px solid #ff0000;
            padding: 40px;
            text-align: center;
            display: none;
            z-index: 1000;
        }
        
        .game-over.show {
            display: block;
        }
        
        .game-over h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #ff0000;
        }
        
        .restart-btn {
            margin-top: 20px;
            padding: 10px 30px;
            background: #1a2633;
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 14px;
        }
        
        .restart-btn:hover {
            background: #2a4066;
        }
        
        .advisor-panel {
            margin-top: 20px;
            border: 1px solid #4a9eff;
            background: #001a33;
        }
        
        .advisor-header {
            padding: 10px 15px;
            background: #1a2633;
            border-bottom: 1px solid #4a9eff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .advisor-tabs {
            display: flex;
            gap: 10px;
        }
        
        .advisor-tab {
            padding: 5px 12px;
            background: #001a33;
            border: 1px solid #2a5580;
            color: #6bb3ff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .advisor-tab:hover {
            background: #1a2633;
            border-color: #4a9eff;
            color: #4a9eff;
        }
        
        .advisor-tab.active {
            background: #2a4066;
            border-color: #4a9eff;
            color: #ffb000;
        }
        
        .advisor-console {
            height: 250px;
            overflow-y: auto;
            padding: 15px;
            background: #000a14;
            font-size: 12px;
        }
        
        .advisor-message {
            margin-bottom: 15px;
            padding: 8px;
            border-left: 2px solid #4a9eff;
            padding-left: 12px;
        }
        
        .advisor-message.user {
            border-left-color: #ffb000;
            color: #ffb000;
        }
        
        .advisor-message.advisor {
            border-left-color: #4a9eff;
        }
        
        .advisor-name {
            font-size: 10px;
            color: #6bb3ff;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .advisor-message.user .advisor-name {
            color: #ffb000;
        }
        
        .advisor-input-area {
            padding: 15px;
            border-top: 1px solid #2a5580;
            background: #001a33;
        }
        
        .advisor-input {
            width: 100%;
            padding: 10px;
            background: #000a14;
            border: 1px solid #2a5580;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .advisor-input:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 5px #4a9eff;
        }
        
        .advisor-send-btn {
            margin-top: 8px;
            padding: 8px 20px;
            background: #1a2633;
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .advisor-send-btn:hover {
            background: #2a4066;
            box-shadow: 0 0 8px #4a9eff;
        }
        
        .advisor-send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            color: #6bb3ff;
            font-style: italic;
            font-size: 11px;
            margin-top: 10px;
            display: none;
        }
        
        .typing-indicator.active {
            display: block;
        }
        
        .briefing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .briefing-overlay.show {
            display: flex;
        }
        
        .briefing-container {
            width: 90%;
            max-width: 1000px;
            height: 80vh;
            background: #0a0a0a;
            border: 2px solid #4a9eff;
            display: flex;
            flex-direction: column;
        }
        
        .briefing-header {
            padding: 20px;
            background: #001a33;
            border-bottom: 2px solid #4a9eff;
            text-align: center;
        }
        
        .briefing-header h2 {
            font-size: 20px;
            letter-spacing: 2px;
            color: #ff0000;
        }
        
        .briefing-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .briefing-slide {
            display: none;
        }
        
        .briefing-slide.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-title {
            font-size: 18px;
            color: #ffb000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a5580;
        }
        
        .slide-section {
            margin-bottom: 25px;
        }
        
        .slide-section h3 {
            font-size: 14px;
            color: #4a9eff;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .slide-text {
            line-height: 1.8;
            color: #ffb000;
        }
        
        .intel-photo {
            border: 1px solid #2a5580;
            padding: 10px;
            margin: 15px 0;
            background: #001a33;
        }
        
        .photo-label {
            font-size: 10px;
            color: #6bb3ff;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .ascii-image {
            font-family: 'Courier New', monospace;
            font-size: 9px;
            line-height: 1;
            color: #4a9eff;
            white-space: pre;
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
        
        .threat-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .threat-item {
            padding: 10px;
            border: 1px solid #2a5580;
            background: #001a33;
        }
        
        .threat-level {
            font-size: 11px;
            color: #6bb3ff;
            margin-bottom: 5px;
        }
        
        .threat-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .threat-high { color: #ff0000; }
        .threat-medium { color: #ffaa00; }
        .threat-low { color: #00ff00; }
        
        .briefing-footer {
            padding: 15px 20px;
            background: #001a33;
            border-top: 1px solid #2a5580;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slide-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            padding: 8px 20px;
            background: #1a2633;
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #2a4066;
            box-shadow: 0 0 8px #4a9eff;
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .slide-counter {
            font-size: 12px;
            color: #6bb3ff;
        }
        
        .tactical-map {
            border: 2px solid #4a9eff;
            padding: 15px;
            background: #000;
            margin: 20px 0;
        }
        
        .map-legend {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
            font-size: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-symbol {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .command-interface {
            margin-top: 20px;
        }
        
        .command-input {
            width: 100%;
            padding: 12px;
            background: #000a14;
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            min-height: 100px;
        }
        
        .command-input:focus {
            outline: none;
            border-color: #6bb3ff;
            box-shadow: 0 0 8px #4a9eff;
        }
        
        .command-input::placeholder {
            color: #6bb3ff;
            opacity: 0.5;
        }
        
        .order-review-panel {
            margin-top: 20px;
            padding: 15px;
            background: #001a33;
            border: 2px solid #ffb000;
        }
        
        .order-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #000a14;
            border-left: 3px solid #4a9eff;
        }
        
        .order-section h4 {
            color: #4a9eff;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .order-item {
            margin: 5px 0;
            padding: 5px;
            font-size: 11px;
            color: #ffb000;
        }
        
        .effect-positive {
            color: #4a9eff;
        }
        
        .effect-negative {
            color: #ff6600;
        }
        
        .effect-neutral {
            color: #ffb000;
        }
        
        .risk-warning {
            color: #ff6600;
            font-size: 11px;
            padding: 8px;
            background: rgba(255, 102, 0, 0.1);
            border-left: 3px solid #ff6600;
            margin: 5px 0;
        }
        
        .critical-warning {
            color: #ff0000;
            font-size: 11px;
            padding: 8px;
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid #ff0000;
            margin: 5px 0;
            font-weight: bold;
        }
        
        .wireframe-map-container {
            margin: 20px 0;
            padding: 0;
            border: 2px solid #4a9eff;
            background: #000;
            position: relative;
            height: 500px;
            z-index: 1;
        }
        
        .wireframe-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #wireframe-map {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        /* Override Leaflet defaults for dark theme */
        .leaflet-container {
            background: #000;
            font-family: 'Courier New', monospace;
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(0, 26, 51, 0.95);
            color: #ffb000;
            border: 1px solid #4a9eff;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .leaflet-popup-tip {
            background: rgba(0, 26, 51, 0.95);
        }
        
        .leaflet-control-zoom a {
            background: rgba(26, 38, 51, 0.9);
            color: #4a9eff;
            border: 1px solid #4a9eff;
        }
        
        .leaflet-control-zoom a:hover {
            background: rgba(42, 64, 102, 0.9);
            color: #ffb000;
        }
        
        .leaflet-bar {
            border: 1px solid #4a9eff;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        
        .map-btn {
            padding: 5px 10px;
            background: rgba(26, 38, 51, 0.8);
            border: 1px solid #4a9eff;
            color: #ffb000;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-btn:hover {
            background: rgba(42, 64, 102, 0.9);
            box-shadow: 0 0 5px #4a9eff;
        }
        
        .map-btn.active {
            background: rgba(42, 64, 102, 0.9);
            border-color: #ffb000;
        }
        
        .map-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 10, 20, 0.9);
            border: 1px solid #4a9eff;
            padding: 10px;
            font-size: 10px;
            color: #ffb000;
            max-width: 250px;
            display: none;
        }
        
        .map-info.show {
            display: block;
        }
        
        .map-legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 10, 20, 0.9);
            border: 1px solid #4a9eff;
            padding: 8px;
            font-size: 9px;
            color: #ffb000;
        }
        
        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border: 1px solid #4a9eff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STRATEGIC CRISIS SIMULATION</h1>
            <div class="classified">CLASSIFIED - EYES ONLY - ADVISOR CLEARANCE REQUIRED</div>
            <div style="margin-top: 10px; font-size: 12px;" id="current-time"></div>
        </div>
        
        <!-- Metrics Ribbon -->
        <div class="metrics-ribbon">
            <div class="metric-item">
                <div class="metric-label">Stability</div>
                <div class="metric-value" id="stability">85</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="stability-bar" style="width: 85%;"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Diplomacy</div>
                <div class="metric-value" id="diplomacy">75</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="diplomacy-bar" style="width: 75%;"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Military</div>
                <div class="metric-value" id="military">70</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="military-bar" style="width: 70%;"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Support</div>
                <div class="metric-value" id="support">80</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="support-bar" style="width: 80%;"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Allies</div>
                <div class="metric-value" id="allies">75</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="allies-bar" style="width: 75%;"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Intel</div>
                <div class="metric-value" id="intelligence">65</div>
                <div class="metric-bar"><div class="metric-bar-fill" id="intelligence-bar" style="width: 65%;"></div></div>
            </div>
            <div class="defcon-indicator">
                <span class="crisis-level" id="crisis-level">DEFCON 5</span>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="situation">SITUATION</button>
            <button class="tab-btn" data-tab="map">MAP</button>
            <button class="tab-btn" data-tab="advisors">ADVISORS</button>
            <button class="tab-btn" data-tab="intel">INTEL FEED</button>
        </div>
        
        <!-- Situation Tab -->
        <div class="tab-content active" id="tab-situation">
            <div class="content-area">
                <div class="situation-report" id="situation-text">
                    Initializing scenario parameters...
                </div>
                
                <div class="command-interface" id="command-interface" style="display: none; margin-top: 20px;">
                    <div class="panel-title">COMMAND INPUT</div>
                    <div style="margin-bottom: 10px; font-size: 11px; color: #6bb3ff;">
                        Issue orders in natural language. Be specific about actions, targets, and timing.
                    </div>
                    <textarea id="player-command" class="command-input" rows="4" placeholder="Enter your orders...

Examples:
‚Ä¢ Deploy the Reagan carrier group to 100nm east of Taiwan, maintain DEFCON 3
‚Ä¢ Initiate backchannel negotiations with Beijing through Singapore embassy
‚Ä¢ Request emergency NATO Article 4 consultation within 24 hours
‚Ä¢ Position B-2 bombers in Guam as deterrent, coordinate with PACOM"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="option-btn" id="submit-command" style="flex: 1;">SUBMIT ORDERS</button>
                        <button class="option-btn" id="show-suggested-options" style="flex: 1;">SUGGEST OPTIONS</button>
                    </div>
                    <div id="processing-indicator" style="display: none; margin-top: 10px; color: #ffb000; font-size: 11px; text-align: center;">
                        <div>‚ü≥ PROCESSING ORDERS...</div>
                        <div style="font-size: 10px; color: #6bb3ff; margin-top: 5px;">Analyzing feasibility and consequences...</div>
                    </div>
                </div>
                
                <div class="order-review-panel" id="order-review" style="display: none; margin-top: 20px;">
                    <div class="panel-title">ORDER CONFIRMATION</div>
                    <div id="order-details"></div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="option-btn" id="approve-orders" style="flex: 1;">APPROVE & EXECUTE</button>
                        <button class="option-btn" id="modify-orders" style="flex: 1;">MODIFY</button>
                        <button class="option-btn" id="cancel-orders" style="flex: 1;">CANCEL</button>
                    </div>
                </div>
                
                <div class="options" id="options-container">
                    <!-- Fallback options if needed -->
                </div>
            </div>
        </div>
        
        <!-- Map Tab -->
        <div class="tab-content" id="tab-map">
            <div class="content-area" style="padding: 0;">
                <div class="wireframe-map-container" style="margin: 0; height: 100%; border: none;">
                    <div class="map-legend">
                        <div class="legend-row">
                            <div class="legend-color" style="background: #4a9eff;"></div>
                            <span>Allied Forces</span>
                        </div>
                        <div class="legend-row">
                            <div class="legend-color" style="background: #ff6600;"></div>
                            <span>Hostile Forces</span>
                        </div>
                        <div class="legend-row">
                            <div class="legend-color" style="background: #ff0000;"></div>
                            <span>Active Threat</span>
                        </div>
                        <div class="legend-row">
                            <div class="legend-color" style="background: #ffb000;"></div>
                            <span>Force Movement</span>
                        </div>
                    </div>
                    <div class="map-controls">
                        <button class="map-btn active" id="map-world">WORLD</button>
                        <button class="map-btn" id="map-pacific">PACIFIC</button>
                        <button class="map-btn" id="map-arctic">ARCTIC</button>
                        <button class="map-btn" id="map-europe">EUROPE</button>
                    </div>
                    <div id="wireframe-map" style="height: 100%;">
                        <div id="map-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #4a9eff; font-size: 12px;">
                            <div>
                                <div style="text-align: center; margin-bottom: 10px;">‚ü≥ LOADING MAP...</div>
                                <div style="text-align: center; font-size: 10px; color: #6bb3ff;">Connecting to tile server...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advisors Tab -->
        <div class="tab-content" id="tab-advisors">
            <div class="content-area">
                <div class="advisor-panel" style="margin: 0; border: none;">
                    <div class="advisor-header" style="background: transparent; border: none; padding: 0 0 10px 0;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="panel-title" style="margin: 0; border: none; padding: 0;">SITUATION ROOM</div>
                            <button class="map-btn" id="view-documents-btn" style="font-size: 10px; padding: 3px 8px;">
                                üìÅ DOCUMENTS (<span id="doc-count">0</span>)
                            </button>
                        </div>
                        <div style="font-size: 10px; color: #6bb3ff;">NSC Advisors standing by</div>
                    </div>
                    <div class="advisor-console" id="advisor-console" style="height: calc(100vh - 350px); max-height: none;">
                        <div class="advisor-message advisor">
                            <div class="advisor-name">[SITUATION ROOM]</div>
                            <div>National Security Council assembled. Advisors: Rachel Chen (NSA), General Marcus Webb (SECDEF), Ambassador Sarah Okonkwo (State), Director James Park (DNI). Ask questions or request analysis.</div>
                        </div>
                    </div>
                    <div class="advisor-input-area">
                        <input type="text" class="advisor-input" id="advisor-input" placeholder="Ask advisors... (e.g., 'What are the risks of deploying the carrier?')"/>
                        <div class="typing-indicator" id="typing-indicator">‚óè Advisors conferring...</div>
                        <button class="advisor-send-btn" id="advisor-send-btn">ASK</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Intel Feed Tab -->
        <div class="tab-content" id="tab-intel">
            <div class="content-area">
                <div class="panel" style="margin: 0; height: 100%;">
                    <div class="panel-title">INTELLIGENCE FEED</div>
                    <div class="intel-feed" id="intel-feed" style="height: calc(100vh - 250px); max-height: none;">
                        <div class="intel-item">
                            <div class="intel-timestamp">[SYSTEM INITIALIZATION]</div>
                            Standing by for scenario deployment...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="briefing-overlay" id="briefing-overlay">
        <div class="briefing-container">
            <div class="briefing-header">
                <div class="classified">TOP SECRET // SPECIAL ACCESS REQUIRED</div>
                <h2 id="briefing-title">CRISIS BRIEFING</h2>
                <div style="margin-top: 5px; font-size: 11px; color: #6bb3ff;">NATIONAL SECURITY COUNCIL</div>
            </div>
            <div class="briefing-content" id="briefing-content">
                <!-- Slides populated by JavaScript -->
            </div>
            <div class="briefing-footer">
                <div class="slide-counter">
                    <span id="current-slide">1</span> / <span id="total-slides">5</span>
                </div>
                <div class="slide-nav">
                    <button class="nav-btn" id="prev-slide">‚óÑ PREVIOUS</button>
                    <button class="nav-btn" id="next-slide">NEXT ‚ñ∫</button>
                    <button class="nav-btn" id="begin-scenario" style="display: none;">BEGIN SCENARIO</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-over" id="game-over">
        <h2 id="game-over-title">SCENARIO CONCLUDED</h2>
        <p id="game-over-text" style="font-size: 14px; margin-bottom: 20px;"></p>
        <button class="restart-btn" onclick="location.reload()">RESTART SIMULATION</button>
    </div>
    
    <script>
        // Sanitize strings before inserting into HTML
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Game state
        let gameState = {
            turn: 0,
            stability: 85,
            diplomacy: 75,
            military: 70,
            support: 80,
            allies: 75,
            intelligence: 65,
            defcon: 5,
            scenario: null,
            regions: {},
            gameOver: false,
            currentAdvisor: 'natsec',
            advisorHistory: {
                natsec: [],
                military: [],
                state: [],
                intel: []
            },
            briefing: {
                currentSlide: 0,
                totalSlides: 0,
                slides: []
            },
            map: {
                view: 'world',
                zoom: 1,
                centerX: 0,
                centerY: 0,
                threats: [],
                forces: [],
                movements: []
            },
            commandMode: true, // Enable natural language commands
            currentOrders: null
        };
        
        // Scenarios
        const scenarios = [
            {
                id: 'taiwan_strait',
                title: 'TAIWAN STRAIT CRISIS',
                description: 'Intelligence indicates large-scale military exercises 90km from Taiwan. PLA Navy assets converging. Unclear if exercise or preparation for action. Allied partners requesting guidance. Markets responding negatively.',
                briefing: {
                    slides: [
                        {
                            title: 'SITUATION OVERVIEW',
                            content: `
                                <div class="slide-section">
                                    <h3>Current Status</h3>
                                    <div class="slide-text">
                                        PLA Eastern Theater Command has initiated "Joint Sword-2026" exercises involving an estimated 87 naval vessels, 
                                        240+ aircraft, and 35,000 personnel. Exercise area encompasses 90km from Taiwan's coast, significantly closer 
                                        than previous exercises. Duration: "Until further notice."
                                    </div>
                                </div>
                                <div class="threat-matrix">
                                    <div class="threat-item">
                                        <div class="threat-level">ESCALATION RISK</div>
                                        <div class="threat-value threat-high">HIGH</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">TIME SENSITIVITY</div>
                                        <div class="threat-value threat-high">CRITICAL</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">ALLIED IMPACT</div>
                                        <div class="threat-value threat-high">SEVERE</div>
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Key Indicators</h3>
                                    <div class="slide-text">
                                        ‚Ä¢ Amphibious assault ships positioned in attack formation<br>
                                        ‚Ä¢ Strategic bomber activity increased 340% over 72hrs<br>
                                        ‚Ä¢ Cyber intrusions targeting Taiwanese critical infrastructure<br>
                                        ‚Ä¢ PLA Rocket Force units in elevated alert status<br>
                                        ‚Ä¢ Commercial shipping warned to avoid exercise zones
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'INTELLIGENCE ASSESSMENT',
                            content: `
                                <div class="intel-photo">
                                    <div class="photo-label">KEYHOLE-17 SATELLITE IMAGERY // CLASSIFIED</div>
                                    <div class="ascii-image">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  FUJIAN COAST - PLA NAVAL CONCENTRATION                            ‚ïë
‚ïë  TIMESTAMP: 2026-02-13 08:42Z                                      ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                    ‚ïë
‚ïë         ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                        ‚ïë
‚ïë     ~~~~~~~~~~~~[DESTROYER]~~~[FRIGATE]~~~~~~~                     ‚ïë
‚ïë   ~~~~~~~~~~[AMPHIB]~~~~~~[AMPHIB]~~~~~~~~~~~~~                    ‚ïë
‚ïë  ~~~~~~~~[CARRIER-076]~~~~~~~~~~~~~~~~~~~~~~~~~                    ‚ïë
‚ïë   ~~~~~~~~~~[AMPHIB]~[DESTROYER]~~~~~~~~~~~~~~~                    ‚ïë
‚ïë     ~~~~~~~~~~~~~~~~~~[FRIGATE]~~~~~~~~~~~~~~~~                    ‚ïë
‚ïë         ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                        ‚ïë
‚ïë                                                                    ‚ïë
‚ïë  ANALYSIS: 13 major surface combatants identified in formation.   ‚ïë
‚ïë  Configuration consistent with amphibious assault preparation.     ‚ïë
‚ïë  Air defense umbrella established. ASW screens active.             ‚ïë
‚ïë                                                                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                                </div>
                                <div class="slide-section">
                                    <h3>Intelligence Summary</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ffaa00;">CONFIDENCE LEVEL: MODERATE-HIGH</strong><br><br>
                                        Current force disposition exceeds requirements for standard exercise. Logistics tail suggests 
                                        sustained operations capability. Three scenarios assessed:<br><br>
                                        <strong style="color: #ff6600;">SCENARIO A (35% probability):</strong> Intimidation exercise following recent trade negotiations<br>
                                        <strong style="color: #ff6600;">SCENARIO B (40% probability):</strong> Preparation for blockade operations<br>
                                        <strong style="color: #ff0000;">SCENARIO C (25% probability):</strong> Precursor to assault operations<br><br>
                                        SIGINT indicates unusual communications security protocols. Leadership rhetoric increasingly 
                                        bellicose. Window for diplomatic intervention: 48-72 hours estimated.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'TACTICAL SITUATION MAP',
                            content: `
                                <div class="tactical-map">
                                    <div class="ascii-image">
                    TAIWAN STRAIT - TACTICAL OVERVIEW
                    
    MAINLAND CHINA                    TAIWAN
         ‚ïë                               ‚ïë
         ‚ïë    [EXERCISE ZONE]           ‚ïë
         ‚ïë    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó            ‚ïë
    [PLA]‚ïë‚ïê‚ïê‚ïê‚ïê‚ï£  90km GAP  ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïë[ROCA]
    BASE ‚ïë    ‚ïë            ‚ïë            ‚ïë BASE
         ‚ïë    ‚ïë ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚ïë            ‚ïë
         ‚ïë    ‚ïë            ‚ïë            ‚ïë
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ï®‚îÄ‚îÄ‚îÄ‚îÄ‚ï®‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï®‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï®‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  ‚ñà ‚ñà ‚ñà  PLA NAVAL ASSETS (87 VESSELS)  ‚îÇ
    ‚îÇ    ‚ñ≤    AIRBORNE EARLY WARNING          ‚îÇ
    ‚îÇ  ‚ñì‚ñì‚ñì‚ñì   AMPHIBIOUS READY GROUP          ‚îÇ
    ‚îÇ   ‚úà‚úà    FIGHTER PATROLS (240+ A/C)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    ‚ïë SHIPPING LANES DISRUPTED
    ‚ïë ADIZ VIOLATIONS: CONSTANT
    ‚ïë CYBER ATTACKS: ONGOING
    ‚ïë 
    ‚ñº ESCALATION LADDER: STEP 7/10
                                    </div>
                                    <div class="map-legend">
                                        <div class="legend-item">
                                            <span class="legend-symbol" style="color: #ff0000;">‚ñà</span>
                                            <span>PLA Forces</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-symbol" style="color: #00ff00;">‚ñà</span>
                                            <span>Allied Forces</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-symbol" style="color: #ffff00;">‚ñ≤</span>
                                            <span>Air Assets</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-symbol" style="color: #00aaff;">‚âà</span>
                                            <span>Naval Assets</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Force Disposition</h3>
                                    <div class="slide-text">
                                        <strong>PLA Eastern Theater Command:</strong> 87 vessels, 240+ aircraft, SAM umbrella established<br>
                                        <strong>Taiwan ROC Forces:</strong> On heightened alert, reserves mobilizing<br>
                                        <strong>US 7th Fleet:</strong> Carrier Strike Group 300nm east of Taiwan<br>
                                        <strong>JSDF:</strong> Monitoring from Okinawa, P-8 Poseidon patrols active
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'STRATEGIC IMPLICATIONS',
                            content: `
                                <div class="slide-section">
                                    <h3>Economic Impact</h3>
                                    <div class="slide-text">
                                        Taiwan produces 92% of world's advanced semiconductors. TSMC fab operations disrupted. 
                                        Global electronics supply chain at risk. Estimated economic cost of prolonged crisis: 
                                        <strong style="color: #ff6600;">$2.1 trillion quarterly</strong>. Shipping insurance rates 
                                        through strait increased 840%. 18 container vessels currently held in exercise zone.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Alliance Dynamics</h3>
                                    <div class="slide-text">
                                        Japan invoked mutual defense consultation clause. South Korea requested clarity on US commitment. 
                                        Australia activated AUKUS coordination protocols. Philippines expressed concern regarding 
                                        potential spillover. NATO allies watching closely - Article 5 precedent implications.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Escalation Pathways</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ff0000;">RED LINE 1:</strong> Blockade declaration triggers treaty obligations<br>
                                        <strong style="color: #ff0000;">RED LINE 2:</strong> Kinetic action against Taiwan forces US response<br>
                                        <strong style="color: #ff0000;">RED LINE 3:</strong> Attacks on US assets initiates direct conflict<br><br>
                                        Current position: Between Yellow and Red thresholds. Ambiguity intentional - tests resolve 
                                        without triggering automatic responses. Salami tactics methodology.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'DECISION TIMELINE',
                            content: `
                                <div class="intel-photo">
                                    <div class="photo-label">DECISION MATRIX // EYES ONLY</div>
                                    <div class="ascii-image">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  CRISIS DECISION TIMELINE                                      ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë  NOW ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ 24 HRS ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ 48 HRS ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ 72 HRS ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ 96 HRS     ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ          ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îÇ            ‚îÇ            ‚îî‚îÄ POINT   ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îÇ            ‚îÇ               OF NO   ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îÇ            ‚îî‚îÄ DIPLOMATIC  RETURN  ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îÇ               WINDOW               ‚ïë
‚ïë   ‚îÇ          ‚îÇ            ‚îî‚îÄ ALLIED      CLOSES                ‚ïë
‚ïë   ‚îÇ          ‚îÇ               COHESION                          ‚ïë
‚ïë   ‚îÇ          ‚îî‚îÄ INITIAL     CRITICAL                           ‚ïë
‚ïë   ‚îÇ             RESPONSE                                       ‚ïë
‚ïë   ‚îî‚îÄ YOU ARE HERE                                              ‚ïë
‚ïë                                                                ‚ïë
‚ïë  RECOMMENDED ACTION: Coordinate response within 12 hours      ‚ïë
‚ïë  MAXIMUM DELAY: 24 hours before allied consensus fractures    ‚ïë
‚ïë                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                                </div>
                                <div class="slide-section">
                                    <h3>Recommended Approach</h3>
                                    <div class="slide-text">
                                        NSC consensus recommendation: <strong style="color: #ffff00;">Immediate multi-track engagement</strong><br><br>
                                        Track 1: Private diplomatic communication to Beijing leadership<br>
                                        Track 2: Coordinate with QUAD partners on unified response<br>
                                        Track 3: Position military assets as deterrent without provocative deployment<br>
                                        Track 4: Activate economic pressure mechanisms (held in reserve)<br><br>
                                        <strong style="color: #ff6600;">NOTE:</strong> Dissenting opinion from SECDEF advocates for 
                                        immediate show of force. Dissenting opinion from State advocates for quiet diplomacy only.
                                        Your decision will set precedent for future Pacific crises.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Available Resources</h3>
                                    <div class="slide-text">
                                        You have full authority to consult advisors, request additional intelligence, and authorize 
                                        preliminary actions. Final decisions on force deployment require your direct authorization.
                                        Intelligence feeds will continue. Situation fluid.
                                    </div>
                                </div>
                            `
                        }
                    ]
                },
                options: [
                    {
                        text: 'Deploy carrier group to region as deterrent',
                        effects: {stability: -10, military: +5, diplomacy: -5, allies: +10},
                        intel: 'Carrier group USS Reagan repositioned. Chinese state media denounces "provocation."',
                        nextPhase: 'escalation'
                    },
                    {
                        text: 'Initiate backchannel negotiations with Beijing',
                        effects: {stability: +5, diplomacy: +10, allies: -5, military: -5},
                        intel: 'Diplomatic feelers sent. Response indicates willingness to discuss terms.',
                        nextPhase: 'negotiation'
                    },
                    {
                        text: 'Coordinate multilateral response through regional allies',
                        effects: {stability: 0, diplomacy: +5, allies: +15, intelligence: +5},
                        intel: 'QUAD partners convening emergency session. Joint statement being drafted.',
                        nextPhase: 'coalition'
                    },
                    {
                        text: 'Impose immediate sanctions on Chinese military-industrial complex',
                        effects: {stability: -15, diplomacy: -10, support: +10, allies: +5},
                        intel: 'Sanctions announced. Beijing recalls ambassador. Trade tensions escalating.',
                        nextPhase: 'economic_war'
                    }
                ]
            },
            {
                id: 'arctic_resources',
                title: 'ARCTIC TERRITORIAL DISPUTE',
                description: 'Russian forces have established new military installations on disputed Arctic islands. NATO allies express concern. Vast resource deposits at stake. Winter conditions complicate response options.',
                briefing: {
                    slides: [
                        {
                            title: 'SITUATION OVERVIEW',
                            content: `
                                <div class="slide-section">
                                    <h3>Current Status</h3>
                                    <div class="slide-text">
                                        Russian Northern Fleet has established permanent military presence on Franz Josef Land and 
                                        Severnaya Zemlya archipelagos. Claims extend EEZ boundaries by 850,000 sq km. Installations 
                                        include S-400 SAM systems, airstrip, and deep-water port facilities. Construction ongoing 
                                        despite extreme weather.
                                    </div>
                                </div>
                                <div class="threat-matrix">
                                    <div class="threat-item">
                                        <div class="threat-level">ESCALATION RISK</div>
                                        <div class="threat-value threat-medium">MODERATE</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">TIME SENSITIVITY</div>
                                        <div class="threat-value threat-medium">WEEKS</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">STRATEGIC VALUE</div>
                                        <div class="threat-value threat-high">CRITICAL</div>
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Key Factors</h3>
                                    <div class="slide-text">
                                        ‚Ä¢ Estimated $35 trillion in oil, gas, and mineral resources<br>
                                        ‚Ä¢ New shipping routes: Northern Sea Route reduces Asia-Europe transit by 40%<br>
                                        ‚Ä¢ Climate change opening previously inaccessible regions<br>
                                        ‚Ä¢ Five competing territorial claims: Russia, Norway, Denmark, Canada, US<br>
                                        ‚Ä¢ Winter conditions limit military response options until May thaw
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'ARCTIC MILITARY SITUATION',
                            content: `
                                <div class="tactical-map">
                                    <div class="ascii-image">
                ARCTIC CIRCLE - CONTESTED TERRITORIES
                
            NORWAY      BARENTS         RUSSIA
              ‚ïë           SEA              ‚ïë
              ‚ïë    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚ïë
         [NATO]‚ïê‚ïê‚ïê‚ïê‚ï° FRANZ JOSEF ‚ïû‚ïê‚ïê‚ïê‚ïê‚ïê[NORTHERN
         BASE ‚ïë    ‚îÇ   ‚ö† ‚ñà ‚ñà ‚ñà   ‚îÇ     FLEET]
              ‚ïë    ‚îÇ  DISPUTED   ‚îÇ         ‚ïë
              ‚ïë    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚ïë
              ‚ïë                            ‚ïë
         SVALBARD        KARA            SEVERNAYA
         TREATY          SEA            ZEMLYA
         ZONE      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚ö† ‚ñà ‚ñà
           ‚îÇ       ‚îÇ             ‚îÇ    NEW BASE
           ‚îÇ       ‚îÇ  LOMONOSOV  ‚îÇ         ‚ïë
         [NATO]    ‚îÇ    RIDGE    ‚îÇ    [RUSSIAN]
         MONITOR   ‚îÇ   (CLAIM)   ‚îÇ    S-400 SAM
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    AIRSTRIP
                                      DEEPWATER
                   NORTH POLE         PORT
                      ‚òÖ
                      
    LEGEND: ‚ñà Military Installation  ‚ö† Contested Zone
            ‚ïê Supply Route  ‚òÖ Disputed Seabed Claims
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Force Assessment</h3>
                                    <div class="slide-text">
                                        <strong>Russian Northern Fleet:</strong> 4 bases, 8 icebreakers, submarine presence<br>
                                        <strong>NATO Forces:</strong> Norwegian Coast Guard, US patrols limited<br>
                                        <strong>Chinese Interest:</strong> "Near-Arctic State" claims, research stations<br>
                                        <strong>Environmental:</strong> Temperatures -40¬∞C, 24hr darkness, ice navigation hazardous
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'STRATEGIC ASSESSMENT',
                            content: `
                                <div class="intel-photo">
                                    <div class="photo-label">SYNTHETIC APERTURE RADAR // CLASSIFIED</div>
                                    <div class="ascii-image">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  FRANZ JOSEF LAND - RUSSIAN BASE CONSTRUCTION                  ‚ïë
‚ïë  SENSOR: SENTINEL-2C SAR / DATE: 2026-02-11                   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë  ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì ICE SHEET                                       ‚ïë
‚ïë  ‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñì                                                   ‚ïë
‚ïë  ‚ñì‚ñë‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚ñë‚ñì  ‚Üê AIRSTRIP (2400m)                             ‚ïë
‚ïë  ‚ñì‚ñë‚îÇ‚ñà‚ñà‚ñà‚ñà‚ñà‚îÇ‚ñë‚ñì                                                   ‚ïë
‚ïë  ‚ñì‚ñë‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚ñë‚ñì  ‚Üê S-400 BATTERY                                ‚ïë
‚ïë  ‚ñì‚ñë  ‚ïî‚ïó‚ïî‚ïó ‚ñë‚ñì                                                   ‚ïë
‚ïë  ‚ñì‚ñë  ‚ïö‚ïù‚ïö‚ïù ‚ñë‚ñì  ‚Üê SAM RADARS (4x)                              ‚ïë
‚ïë  ‚ñì‚ñë‚âà‚âà‚âà‚âà‚âà‚âà‚âà‚ñë‚ñì                                                   ‚ïë
‚ïë  ‚ñì‚ñëHARBOR ‚ñë‚ñì  ‚Üê DEEP WATER PORT                               ‚ïë
‚ïë  ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì                                                   ‚ïë
‚ïë                                                                ‚ïë
‚ïë  ANALYSIS: Construction 73% complete. Year-round operations   ‚ïë
‚ïë  capability by April 2026. Covers 450nm radius of Arctic.     ‚ïë
‚ïë                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                                </div>
                                <div class="slide-section">
                                    <h3>Legal Framework</h3>
                                    <div class="slide-text">
                                        UN Convention on Law of the Sea (UNCLOS) governs territorial claims. Russia submitted 
                                        continental shelf extension claim in 2015. Denmark, Canada counter-claims overlap. 
                                        US not UNCLOS signatory - legal standing ambiguous. International Tribunal for Law 
                                        of Sea has jurisdiction but enforcement mechanisms weak.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'ECONOMIC & ALLIANCE IMPLICATIONS',
                            content: `
                                <div class="slide-section">
                                    <h3>Resource Competition</h3>
                                    <div class="slide-text">
                                        Control of Lomonosov Ridge seabed grants rights to estimated 13% of undiscovered global oil, 
                                        30% of undiscovered natural gas. Rare earth minerals critical for defense industry. 
                                        Northern Sea Route transit fees: potential $100B annually. Energy independence implications 
                                        for Europe. Russia currently holds dominant position.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>NATO Cohesion</h3>
                                    <div class="slide-text">
                                        Norway invoked Article 4 consultations. Canada demands stronger response. Denmark requests 
                                        NATO presence in Greenland. US Arctic strategy under review. Concerns about setting 
                                        precedent for territorial claims. Nordic countries vulnerable to Russian energy coercion. 
                                        Winter limits military options - must act before spring thaw enables Russian reinforcement.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Chinese Dimension</h3>
                                    <div class="slide-text">
                                        Beijing declared itself "near-Arctic state" despite being 3000km south of Arctic Circle. 
                                        Research stations in Iceland, Norway. "Polar Silk Road" initiative coordinates with Russian 
                                        claims. Joint exercises planned. Potential Sino-Russian Arctic bloc threatens NATO interests.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'RESPONSE OPTIONS ANALYSIS',
                            content: `
                                <div class="slide-section">
                                    <h3>Time Factors</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ffff00;">IMMEDIATE (0-4 weeks):</strong> Winter conditions limit operations. 
                                        Diplomatic action feasible. Legal filings possible.<br><br>
                                        <strong style="color: #ffaa00;">NEAR-TERM (1-3 months):</strong> Spring thaw enables reinforcement. 
                                        Military options viable but escalatory.<br><br>
                                        <strong style="color: #ff6600;">LONG-TERM (3+ months):</strong> Installations become permanent. 
                                        Fait accompli difficult to reverse. Precedent set for future territorial grabs.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Recommended Strategy</h3>
                                    <div class="slide-text">
                                        Multi-track approach combining legal, diplomatic, and military elements. Avoid direct 
                                        confrontation in winter months. Build coalition consensus. Prepare forward operating 
                                        capability in allied Arctic territory. File comprehensive legal challenge. Consider 
                                        resource-sharing framework to de-escalate competition. Key: prevent Chinese involvement 
                                        while maintaining NATO unity.
                                    </div>
                                </div>
                            `
                        }
                    ]
                },
                options: [
                    {
                        text: 'File international tribunal challenge',
                        effects: {stability: +5, diplomacy: +15, support: +5, military: -10},
                        intel: 'Legal proceedings initiated. Process will take months. Russia dismisses tribunal authority.',
                        nextPhase: 'legal'
                    },
                    {
                        text: 'Establish forward operating bases in allied Arctic territory',
                        effects: {stability: -5, military: +10, allies: +10, diplomacy: -5},
                        intel: 'Bases activated in Norway, Canada. Russian response includes bomber patrols.',
                        nextPhase: 'militarization'
                    },
                    {
                        text: 'Propose Arctic resource-sharing framework',
                        effects: {stability: +10, diplomacy: +10, support: -10, allies: -5},
                        intel: 'Framework proposal circulated. Mixed reception. China expresses interest as "stakeholder."',
                        nextPhase: 'framework'
                    },
                    {
                        text: 'Launch covert intelligence operations in disputed zones',
                        effects: {stability: -10, intelligence: +15, diplomacy: -15, military: +5},
                        intel: 'Reconnaissance assets deployed. Signals intelligence gathering enhanced.',
                        nextPhase: 'covert'
                    }
                ]
            },
            {
                id: 'cyber_attack',
                title: 'CRITICAL INFRASTRUCTURE BREACH',
                description: 'Major cyberattack targeting power grid and financial systems. Attribution points to state-sponsored actors. Cascading failures possible. Population demands response. NATO Article 5 invocation under discussion.',
                briefing: {
                    slides: [
                        {
                            title: 'INCIDENT OVERVIEW',
                            content: `
                                <div class="slide-section">
                                    <h3>Attack Timeline</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ff0000;">T-00:00 (06:23 EST):</strong> Malware activated across Eastern Interconnection power grid<br>
                                        <strong style="color: #ff0000;">T+00:07:</strong> SCADA systems compromised, 23 substations offline<br>
                                        <strong style="color: #ff0000;">T+00:12:</strong> Simultaneous attack on SWIFT financial network detected<br>
                                        <strong style="color: #ff0000;">T+00:18:</strong> 47 million customers without power, 6 states affected<br>
                                        <strong style="color: #ff0000;">T+01:30:</strong> $230B in fraudulent transactions attempted<br>
                                        <strong style="color: #ff0000;">T+02:45:</strong> YOU ARE HERE - Attack ongoing, systems degraded
                                    </div>
                                </div>
                                <div class="threat-matrix">
                                    <div class="threat-item">
                                        <div class="threat-level">IMMEDIATE THREAT</div>
                                        <div class="threat-value threat-high">CRITICAL</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">CASCADING RISK</div>
                                        <div class="threat-value threat-high">SEVERE</div>
                                    </div>
                                    <div class="threat-item">
                                        <div class="threat-level">PUBLIC IMPACT</div>
                                        <div class="threat-value threat-high">MASSIVE</div>
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Current Status</h3>
                                    <div class="slide-text">
                                        Power restoration: 6-12 hours estimated. Financial systems quarantined, markets halted. 
                                        Emergency services operating on backup power. Communications infrastructure degraded. 
                                        Public panic increasing. Emergency response teams deployed. Cyber Command activated.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'ATTACK ATTRIBUTION',
                            content: `
                                <div class="intel-photo">
                                    <div class="photo-label">NSA SIGINT ANALYSIS // TS//SI//TK</div>
                                    <div class="ascii-image">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  MALWARE SIGNATURE ANALYSIS                                    ‚ïë
‚ïë  CLASSIFICATION: TOP SECRET // SPECIAL INTELLIGENCE            ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë  CODE FAMILY: "SANDWORM" (APT44)                              ‚ïë
‚ïë  ATTRIBUTION: GRU Unit 74455 (HIGH CONFIDENCE)                ‚ïë
‚ïë                                                                ‚ïë
‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚ïë
‚ïë  ‚îÇ ATTACK VECTOR CHAIN:                             ‚îÇ         ‚ïë
‚ïë  ‚îÇ                                                   ‚îÇ         ‚ïë
‚ïë  ‚îÇ  INITIAL     LATERAL     PERSISTENCE   PAYLOAD   ‚îÇ         ‚ïë
‚ïë  ‚îÇ  ACCESS  ‚îÄ‚îÄ‚ñ∫ MOVEMENT ‚îÄ‚îÄ‚ñ∫ MECHANISM ‚îÄ‚îÄ‚ñ∫ TRIGGER  ‚îÇ         ‚ïë
‚ïë  ‚îÇ    ‚îÇ           ‚îÇ            ‚îÇ            ‚îÇ       ‚îÇ         ‚ïë
‚ïë  ‚îÇ  SPEAR     NETWORK      BACKDOOR     WIPER +     ‚îÇ         ‚ïë
‚ïë  ‚îÇ  PHISH     PROPAGATE    INSTALL      RANSOMWARE  ‚îÇ         ‚ïë
‚ïë  ‚îÇ    ‚îÇ           ‚îÇ            ‚îÇ            ‚îÇ       ‚îÇ         ‚ïë
‚ïë  ‚îÇ  [JAN 15]  [JAN 20]    [FEB 01]    [FEB 13]    ‚îÇ         ‚ïë
‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚ïë
‚ïë                                                                ‚ïë
‚ïë  CORRELATION WITH PREVIOUS ATTACKS:                           ‚ïë
‚ïë  ‚Ä¢ Ukraine Grid 2015 (92% code similarity)                   ‚ïë
‚ïë  ‚Ä¢ NotPetya 2017 (infrastructure overlap)                    ‚ïë
‚ïë  ‚Ä¢ Olympics 2018 (TTPs match)                                ‚ïë
‚ïë                                                                ‚ïë
‚ïë  C2 INFRASTRUCTURE: Routed through compromised infrastructure ‚ïë
‚ïë  in 14 countries. Ultimate origin: St. Petersburg, Russia.    ‚ïë
‚ïë                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                                </div>
                                <div class="slide-section">
                                    <h3>Intelligence Assessment</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ffff00;">CONFIDENCE: HIGH (85%)</strong><br><br>
                                        Attribution to Russian GRU based on: malware signatures, infrastructure analysis, 
                                        TTPs matching known APT44 operations, SIGINT correlation. Attack sophistication indicates 
                                        state-level resources. Timing suggests coordination with ongoing geopolitical tensions. 
                                        Deniability architecture intentional but penetrable. Alternative hypothesis of false flag: 
                                        <strong style="color: #00ff00;">LOW (15%)</strong>
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'INFRASTRUCTURE DAMAGE ASSESSMENT',
                            content: `
                                <div class="tactical-map">
                                    <div class="ascii-image">
            CRITICAL INFRASTRUCTURE STATUS MAP
            
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë   POWER GRID STATUS - EASTERN INTERCONNECTION ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë                                               ‚ïë
        ‚ïë     CANADA                                    ‚ïë
        ‚ïë       ‚îÉ                                       ‚ïë
        ‚ïë   ‚îå‚îÄ‚îÄ‚îÄ‚ïã‚îÄ‚îÄ‚îÄ‚îê  [OPERATIONAL: ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 67%]    ‚ïë
        ‚ïë   ‚îÇ ‚úì ‚úì ‚úó ‚îÇ                                  ‚ïë
        ‚ïë   ‚îÇ ‚úì ‚úó ‚úó ‚îÇ  [DEGRADED:    ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 23%]    ‚ïë
        ‚ïë   ‚îÇ ‚úó ‚úó ‚úó ‚îÇ                                  ‚ïë
        ‚ïë   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  [OFFLINE:     ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 10%]    ‚ïë
        ‚ïë                                               ‚ïë
        ‚ïë   ‚úì = ONLINE      ‚úó = COMPROMISED            ‚ïë
        ‚ïë                                               ‚ïë
        ‚ïë   FINANCIAL SYSTEMS:                          ‚ïë
        ‚ïë   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚ïë
        ‚ïë   ‚îÇ NYSE:        [HALTED]           ‚îÇ        ‚ïë
        ‚ïë   ‚îÇ NASDAQ:      [HALTED]           ‚îÇ        ‚ïë
        ‚ïë   ‚îÇ SWIFT:       [DEGRADED]         ‚îÇ        ‚ïë
        ‚ïë   ‚îÇ FEDWIRE:     [ISOLATED]         ‚îÇ        ‚ïë
        ‚ïë   ‚îÇ ACH:         [OFFLINE]          ‚îÇ        ‚ïë
        ‚ïë   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚ïë
        ‚ïë                                               ‚ïë
        ‚ïë   ESTIMATED RESTORATION: 6-12 HRS            ‚ïë
        ‚ïë   ECONOMIC IMPACT: $180B+ DAILY              ‚ïë
        ‚ïë                                               ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Cascading Effects</h3>
                                    <div class="slide-text">
                                        Water treatment plants on backup power (12hr capacity). Hospital generators operational 
                                        but fuel supplies finite. Communications towers degrading. Traffic control systems failing. 
                                        Food supply chain disrupted. Fuel distribution compromised. Social order stress increasing. 
                                        Looting reported in 3 major cities. National Guard activation under consideration.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'LEGAL & ALLIANCE FRAMEWORK',
                            content: `
                                <div class="slide-section">
                                    <h3>NATO Article 5 Considerations</h3>
                                    <div class="slide-text">
                                        NATO Secretary General requested emergency North Atlantic Council meeting. Article 5 
                                        ("an armed attack against one... shall be considered an attack against all") traditionally 
                                        applied to kinetic warfare. Cyber attack invocation: unprecedented territory.<br><br>
                                        <strong>Precedent factors:</strong><br>
                                        ‚Ä¢ Estonia 2007: Not invoked (pre-Wales Summit cyber policy)<br>
                                        ‚Ä¢ Wales Summit 2014: Confirmed cyber can trigger Article 5<br>
                                        ‚Ä¢ Warsaw Summit 2016: Cyber recognized as operational domain<br>
                                        ‚Ä¢ Brussels Summit 2021: Cyber deterrence policy adopted<br><br>
                                        <strong style="color: #ffaa00;">DECISION POINT:</strong> Invoking Article 5 for cyber attack 
                                        establishes precedent. Allies watching closely. Some allies hesitant about escalation.
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Domestic Legal Authority</h3>
                                    <div class="slide-text">
                                        President has authority under Title 10, Title 50 USC for cyber operations. Cyber Command 
                                        has defensive and offensive capabilities. Proportional response doctrine applies. 
                                        International law on cyber warfare: developing area. Tallinn Manual provides framework 
                                        but lacks enforcement. UN discussions ongoing but no binding treaty.
                                    </div>
                                </div>
                            `
                        },
                        {
                            title: 'RESPONSE OPTIONS & RISKS',
                            content: `
                                <div class="slide-section">
                                    <h3>Strategic Considerations</h3>
                                    <div class="slide-text">
                                        <strong style="color: #ff6600;">ESCALATION RISKS:</strong><br>
                                        ‚Ä¢ Cyber response may provoke kinetic retaliation<br>
                                        ‚Ä¢ Article 5 invocation commits NATO to collective action<br>
                                        ‚Ä¢ Proportionality assessment difficult in cyber domain<br>
                                        ‚Ä¢ Collateral damage in interconnected systems<br>
                                        ‚Ä¢ Attribution confidence required for legitimate response<br><br>
                                        <strong style="color: #00ff00;">DE-ESCALATION OPPORTUNITIES:</strong><br>
                                        ‚Ä¢ Defensive posture limits escalation spiral<br>
                                        ‚Ä¢ Diplomatic channels remain open<br>
                                        ‚Ä¢ Private attribution avoids public commitment<br>
                                        ‚Ä¢ Economic pressure as alternative to kinetic response<br>
                                        ‚Ä¢ Time to build international consensus
                                    </div>
                                </div>
                                <div class="slide-section">
                                    <h3>Immediate Priorities</h3>
                                    <div class="slide-text">
                                        <strong>1. CONTAIN:</strong> Isolate compromised systems, prevent further spread<br>
                                        <strong>2. RESTORE:</strong> Prioritize critical infrastructure recovery<br>
                                        <strong>3. ATTRIBUTE:</strong> Complete forensic analysis for definitive attribution<br>
                                        <strong>4. COMMUNICATE:</strong> Public messaging, allied coordination<br>
                                        <strong>5. RESPOND:</strong> Proportional action within international law<br><br>
                                        National Security Council recommendation: Begin with defensive measures while maintaining 
                                        offensive capability. Coordinate with allies before major decisions. Your authority includes 
                                        activating cyber response capabilities - final escalation decisions require your approval.
                                    </div>
                                </div>
                            `
                        }
                    ]
                },
                options: [
                    {
                        text: 'Launch proportional counter-cyber operation',
                        effects: {stability: -15, military: +5, support: +15, intelligence: +10},
                        intel: 'Cyber command authorized. Target systems compromised. Retaliation expected.',
                        nextPhase: 'cyber_escalation'
                    },
                    {
                        text: 'Convene emergency UN Security Council session',
                        effects: {stability: 0, diplomacy: +15, support: -10, allies: +5},
                        intel: 'UNSC debate scheduled. Veto expected from adversary. Buys time for recovery.',
                        nextPhase: 'diplomatic'
                    },
                    {
                        text: 'Activate emergency response and harden defenses',
                        effects: {stability: +10, support: +10, military: -5, diplomacy: 0},
                        intel: 'Emergency protocols engaged. Critical systems isolated. Recovery underway.',
                        nextPhase: 'defensive'
                    },
                    {
                        text: 'Invoke NATO Article 5 - collective defense',
                        effects: {stability: -20, allies: +20, diplomacy: -15, military: +15},
                        intel: 'Article 5 invoked for cyber attack. Historic precedent. Alliance mobilizing.',
                        nextPhase: 'article_5'
                    }
                ]
            }
        ];
        
        // Initialize game
        function initGame() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Initialize tab system
            initTabs();
            
            // Wait for Leaflet to load before initializing map
            waitForLeaflet().then(() => {
                initLeafletMap();
            }).catch((error) => {
                console.error('Failed to load Leaflet:', error);
                document.getElementById('wireframe-map').innerHTML = 
                    '<div style="color: #ff0000; padding: 20px; text-align: center;">MAP UNAVAILABLE: External map library failed to load. Check internet connection or firewall settings.</div>';
            });
            
            // Initialize advisor system
            initAdvisorSystem();
            
            // Start with random scenario
            startScenario(scenarios[Math.floor(Math.random() * scenarios.length)]);
        }
        
        // Tab System
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    switchTab(tabId);
                });
            });
        }
        
        function switchTab(tabId) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // If switching to map, refresh size
            if (tabId === 'map' && leafletMap) {
                setTimeout(() => leafletMap.invalidateSize(), 100);
            }
        }
        
        // Wait for Leaflet library to load
        function waitForLeaflet() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max wait
                
                const checkLeaflet = () => {
                    if (typeof L !== 'undefined') {
                        console.log('Leaflet loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Leaflet failed to load after 5 seconds'));
                    } else {
                        attempts++;
                        setTimeout(checkLeaflet, 100);
                    }
                };
                
                checkLeaflet();
            });
        }
        
        // Leaflet Map System
        let leafletMap;
        let mapMarkers = [];
        let mapLayers = {
            threats: L.layerGroup(),
            forces: L.layerGroup(),
            movements: L.layerGroup()
        };
        
        // Custom pulsing icon for threats
        const pulsingIcon = L.divIcon({
            className: 'pulsing-threat',
            html: '<div style="width: 20px; height: 20px; background: #ff0000; border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px #ff0000;"></div>',
            iconSize: [20, 20]
        });
        
        function initLeafletMap() {
            // Check if Leaflet loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet failed to load. Check CDN connection.');
                document.getElementById('wireframe-map').innerHTML = 
                    '<div style="color: #ff0000; padding: 20px; text-align: center;">MAP ERROR: Leaflet library failed to load. Check internet connection.</div>';
                return;
            }
            
            try {
                // Clear loading indicator
                const loadingDiv = document.getElementById('map-loading');
                if (loadingDiv) loadingDiv.remove();
                
                // Initialize map
                leafletMap = L.map('wireframe-map', {
                    center: [30, 0],
                    zoom: 2,
                    minZoom: 2,
                    maxZoom: 6,
                    zoomControl: true,
                    attributionControl: false
                });
                
                // Add dark tile layer with minimal styling
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(leafletMap);
                
                // Force map to recognize its size
                setTimeout(() => {
                    leafletMap.invalidateSize();
                }, 100);
                
                // Add wireframe overlay layer
                addWireframeOverlay();
                
                // Add layer groups
                mapLayers.threats.addTo(leafletMap);
                mapLayers.forces.addTo(leafletMap);
                mapLayers.movements.addTo(leafletMap);
                
                // Add strategic locations
                addStrategicLocations();
                
                // Map controls
                document.getElementById('map-world').addEventListener('click', () => setLeafletView('world'));
                document.getElementById('map-pacific').addEventListener('click', () => setLeafletView('pacific'));
                document.getElementById('map-arctic').addEventListener('click', () => setLeafletView('arctic'));
                document.getElementById('map-europe').addEventListener('click', () => setLeafletView('europe'));
                
                // Add CSS for pulsing animation
                if (!document.getElementById('map-animations')) {
                    const style = document.createElement('style');
                    style.id = 'map-animations';
                    style.textContent = `
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); opacity: 0.8; }
                            50% { transform: scale(1.5); opacity: 0.3; }
                        }
                        .threat-circle {
                            animation: pulse 2s infinite;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                console.log('Leaflet map initialized successfully');
            } catch (error) {
                console.error('Error initializing Leaflet map:', error);
                document.getElementById('wireframe-map').innerHTML = 
                    '<div style="color: #ff0000; padding: 20px; text-align: center;">MAP ERROR: ' + error.message + '</div>';
            }
        }
        
        function addWireframeOverlay() {
            // Add grid lines overlay
            const gridLayer = L.layerGroup();
            
            // Latitude lines
            for (let lat = -80; lat <= 80; lat += 20) {
                const line = L.polyline([
                    [lat, -180],
                    [lat, 180]
                ], {
                    color: '#4a9eff',
                    weight: 0.5,
                    opacity: 0.2,
                    interactive: false
                });
                gridLayer.addLayer(line);
            }
            
            // Longitude lines
            for (let lng = -180; lng <= 180; lng += 20) {
                const line = L.polyline([
                    [-80, lng],
                    [80, lng]
                ], {
                    color: '#4a9eff',
                    weight: 0.5,
                    opacity: 0.2,
                    interactive: false
                });
                gridLayer.addLayer(line);
            }
            
            gridLayer.addTo(leafletMap);
        }
        
        function addStrategicLocations() {
            const locations = [
                // US & Allies
                { name: 'Washington DC', lat: 38.9, lng: -77.0, type: 'capital', faction: 'allied' },
                { name: 'Pearl Harbor', lat: 21.3, lng: -157.8, type: 'naval_base', faction: 'allied' },
                { name: 'Guam', lat: 13.4, lng: 144.7, type: 'naval_base', faction: 'allied' },
                { name: 'Tokyo', lat: 35.6, lng: 139.7, type: 'capital', faction: 'allied' },
                { name: 'Seoul', lat: 37.5, lng: 127.0, type: 'capital', faction: 'allied' },
                { name: 'London', lat: 51.5, lng: -0.1, type: 'capital', faction: 'allied' },
                { name: 'Brussels', lat: 50.8, lng: 4.3, type: 'capital', faction: 'allied' },
                
                // Adversaries
                { name: 'Beijing', lat: 39.9, lng: 116.4, type: 'capital', faction: 'hostile' },
                { name: 'Moscow', lat: 55.7, lng: 37.6, type: 'capital', faction: 'hostile' },
                { name: 'Tehran', lat: 35.6, lng: 51.4, type: 'capital', faction: 'hostile' },
                
                // Flashpoints
                { name: 'Taiwan', lat: 25.0, lng: 121.5, type: 'flashpoint', faction: 'contested' },
                { name: 'Ukraine', lat: 50.4, lng: 30.5, type: 'flashpoint', faction: 'contested' },
                { name: 'South China Sea', lat: 12.0, lng: 114.0, type: 'flashpoint', faction: 'contested' },
                { name: 'Arctic', lat: 75.0, lng: 0.0, type: 'flashpoint', faction: 'contested' },
                { name: 'Strait of Hormuz', lat: 26.5, lng: 56.2, type: 'flashpoint', faction: 'contested' }
            ];
            
            locations.forEach(loc => {
                let color, iconHtml, iconSize;
                
                if (loc.faction === 'allied') color = '#4a9eff';
                else if (loc.faction === 'hostile') color = '#ff6600';
                else if (loc.faction === 'contested') color = '#ffb000';
                else color = '#888888';
                
                if (loc.type === 'capital') {
                    // Square for capitals
                    iconHtml = `<div style="width: 8px; height: 8px; background: ${color}; border: 2px solid ${color};"></div>`;
                    iconSize = [12, 12];
                } else if (loc.type === 'naval_base') {
                    // Triangle for bases
                    iconHtml = `<div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid ${color};"></div>`;
                    iconSize = [12, 10];
                } else if (loc.type === 'flashpoint') {
                    // Pulsing circle for flashpoints
                    iconHtml = `<div class="threat-circle" style="width: 12px; height: 12px; background: ${color}; border-radius: 50%; border: 2px solid #ff0000; box-shadow: 0 0 10px #ff0000;"></div>`;
                    iconSize = [16, 16];
                } else {
                    iconHtml = `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`;
                    iconSize = [8, 8];
                }
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml,
                    iconSize: iconSize
                });
                
                const marker = L.marker([loc.lat, loc.lng], { icon: icon })
                    .bindPopup(`
                        <strong style="color: ${color};">${loc.name}</strong><br>
                        Type: ${loc.type.replace('_', ' ').toUpperCase()}<br>
                        Status: ${loc.faction.toUpperCase()}
                    `)
                    .addTo(mapLayers.forces);
                
                // Add label for major locations
                if (loc.type === 'capital' || loc.type === 'flashpoint') {
                    const label = L.marker([loc.lat, loc.lng], {
                        icon: L.divIcon({
                            className: 'location-label',
                            html: `<div style="color: ${color}; font-size: 9px; white-space: nowrap; margin-left: 10px;">${loc.name}</div>`,
                            iconSize: [100, 20]
                        }),
                        interactive: false
                    }).addTo(mapLayers.forces);
                }
                
                mapMarkers.push({ marker, data: loc });
            });
        }
        
        function setLeafletView(view) {
            // Update active button
            document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`map-${view}`).classList.add('active');
            
            gameState.map.view = view;
            
            if (view === 'world') {
                leafletMap.setView([30, 0], 2);
            } else if (view === 'pacific') {
                leafletMap.setView([25, 135], 4);
            } else if (view === 'arctic') {
                leafletMap.setView([75, 0], 3);
            } else if (view === 'europe') {
                leafletMap.setView([50, 20], 4);
            }
        }
        
        function addThreat(lat, lng, label) {
            // Add expanding threat circle
            const circle = L.circle([lat, lng], {
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.2,
                radius: 200000,
                className: 'threat-circle'
            }).bindPopup(`<strong style="color: #ff0000;">THREAT: ${label}</strong>`)
              .addTo(mapLayers.threats);
            
            // Add threat marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'threat-marker',
                    html: `<div style="width: 8px; height: 8px; background: #ff0000; border-radius: 50%; box-shadow: 0 0 15px #ff0000;"></div>`,
                    iconSize: [8, 8]
                })
            }).addTo(mapLayers.threats);
            
            // Add label
            const labelMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'threat-label',
                    html: `<div style="color: #ff0000; font-size: 10px; font-weight: bold; white-space: nowrap; margin-left: 15px; text-shadow: 0 0 5px #000;">${label}</div>`,
                    iconSize: [150, 20]
                }),
                interactive: false
            }).addTo(mapLayers.threats);
            
            gameState.map.threats.push({ circle, marker, labelMarker, label });
        }
        
        function addForceMovement(fromLat, fromLng, toLat, toLng, label, color) {
            color = color || '#ffb000';
            
            // Draw movement line
            const line = L.polyline(
                [[fromLat, fromLng], [toLat, toLng]],
                {
                    color: color,
                    weight: 3,
                    opacity: 0.8,
                    dashArray: '10, 10',
                    className: 'force-movement-line'
                }
            ).addTo(mapLayers.movements);
            
            // Add animated marker
            const movingMarker = L.marker([fromLat, fromLng], {
                icon: L.divIcon({
                    className: 'moving-force',
                    html: `<div style="width: 10px; height: 10px; background: ${color}; border-radius: 50%; box-shadow: 0 0 10px ${color};"></div>`,
                    iconSize: [10, 10]
                })
            }).bindPopup(`<strong style="color: ${color};">${label}</strong><br>En route...`)
              .addTo(mapLayers.movements);
            
            // Animate marker along path
            animateMarkerAlongPath(movingMarker, fromLat, fromLng, toLat, toLng, 3000);
            
            gameState.map.movements.push({ line, marker: movingMarker, label });
        }
        
        function animateMarkerAlongPath(marker, fromLat, fromLng, toLat, toLng, duration) {
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const lat = fromLat + (toLat - fromLat) * progress;
                const lng = fromLng + (toLng - fromLng) * progress;
                
                marker.setLatLng([lat, lng]);
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }
        
        function clearMapThreats() {
            mapLayers.threats.clearLayers();
            gameState.map.threats = [];
        }
        
        function clearMapMovements() {
            mapLayers.movements.clearLayers();
            gameState.map.movements = [];
        }
        
        // Advisor System
        function initAdvisorSystem() {
            // Initialize documents array
            if (!gameState.documents) gameState.documents = [];
            
            // Send button
            document.getElementById('advisor-send-btn').addEventListener('click', sendAdvisorQuery);
            
            // Documents button
            document.getElementById('view-documents-btn').addEventListener('click', showDocumentLibrary);
            
            // Enter key
            document.getElementById('advisor-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendAdvisorQuery();
                }
            });
        }
        
        function showDocumentLibrary() {
            const docs = gameState.documents || [];
            
            const modal = document.createElement('div');
            modal.id = 'document-library';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const docList = docs.length > 0 
                ? docs.map(doc => `
                    <div style="
                        padding: 10px;
                        border-left: 3px solid #4a9eff;
                        background: #001a33;
                        margin-bottom: 10px;
                        cursor: pointer;
                    " onclick="openDocument('${doc.id}', '${doc.author}', \`${doc.content.replace(/`/g, '\\`')}\`)">
                        <div style="color: #4a9eff; font-weight: bold; font-size: 11px;">${doc.author}</div>
                        <div style="color: #6bb3ff; font-size: 10px; margin-top: 3px;">
                            ${new Date(doc.timestamp).toLocaleString()}
                        </div>
                        <div style="color: #ffb000; font-size: 11px; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${escapeHTML(doc.content.substring(0, 80))}...
                        </div>
                    </div>
                `).join('')
                : '<div style="color: #6bb3ff; text-align: center; padding: 20px;">No documents generated yet. Advisors will create reports when you ask for analysis.</div>';
            
            modal.innerHTML = `
                <div style="
                    background: #001a33;
                    border: 2px solid #4a9eff;
                    padding: 20px;
                    max-width: 800px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    color: #ffb000;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #4a9eff;">
                        <div>
                            <div style="color: #4a9eff; font-weight: bold; font-size: 14px;">DOCUMENT LIBRARY</div>
                            <div style="font-size: 10px; color: #6bb3ff; margin-top: 5px;">${docs.length} document(s)</div>
                        </div>
                        <button onclick="document.getElementById('document-library').remove()" style="
                            background: #1a2633;
                            border: 1px solid #4a9eff;
                            color: #ffb000;
                            padding: 5px 15px;
                            cursor: pointer;
                            font-family: 'Courier New', monospace;
                        ">CLOSE</button>
                    </div>
                    <div>${docList}</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function updateDocumentCount() {
            const count = gameState.documents ? gameState.documents.length : 0;
            const counter = document.getElementById('doc-count');
            if (counter) counter.textContent = count;
        }
        
        async function sendAdvisorQuery() {
            const input = document.getElementById('advisor-input');
            const query = input.value.trim();
            
            if (!query || gameState.gameOver) return;
            
            // Add user message
            addAdvisorMessage('user', 'YOU', query);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            document.getElementById('typing-indicator').classList.add('active');
            document.getElementById('advisor-send-btn').disabled = true;
            
            // Get AI response
            const responses = await getSituationRoomResponse(query);
            
            // Add advisor responses
            responses.forEach(response => {
                addAdvisorMessage('advisor', response.advisor, response.message, response.attachment);
            });
            
            // Hide typing indicator
            document.getElementById('typing-indicator').classList.remove('active');
            document.getElementById('advisor-send-btn').disabled = false;
        }
        
        async function getSituationRoomResponse(query) {
            const situationContext = `
CURRENT CRISIS: ${gameState.scenario ? gameState.scenario.title : 'Standby'}
TURN: ${gameState.turn}
STRATEGIC METRICS:
- Stability: ${gameState.stability}/100
- Diplomatic Capital: ${gameState.diplomacy}/100
- Military Readiness: ${gameState.military}/100
- Public Support: ${gameState.support}/100
- Allied Confidence: ${gameState.allies}/100
- Intelligence Score: ${gameState.intelligence}/100
- DEFCON: ${gameState.defcon}

${gameState.scenario ? 'SITUATION: ' + gameState.scenario.description : ''}
            `.trim();
            
            try {
                const response = await fetch('/api/advisor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{
                            role: 'user',
                            content: `You are running a National Security Council situation room. Advisors present:

- Rachel Chen (NSA - National Security Advisor): Strategic synthesis, balances all factors
- General Marcus Webb (SECDEF - Secretary of Defense): Military options, force readiness  
- Ambassador Sarah Okonkwo (State - Secretary of State): Diplomacy, alliances, international law
- Director James Park (DNI - Director of National Intelligence): Intelligence analysis, enemy intentions

${situationContext}

QUESTION FROM PRESIDENT: "${query}"

Determine which advisor(s) should respond based on their expertise. Output VALID JSON ARRAY (no markdown, no code blocks):
[
    {
        "advisor": "Rachel Chen|General Webb|Ambassador Okonkwo|Director Park",
        "message": "Brief spoken response (2-3 sentences max, first person)",
        "attachment": "OPTIONAL: If question requests analysis/report, provide structured data here (intel report, force assessment, etc). Otherwise null. Keep under 150 words."
    }
]

RULES:
- Multiple advisors respond if question touches multiple domains
- Keep spoken message BRIEF (2-3 sentences)
- Only include attachment if question explicitly asks for analysis/report/assessment OR if complex data would help
- Advisors can disagree with each other
- Use first person ("I recommend..." not "NSA recommends...")
- If simple question, one advisor responds
- Return valid JSON array only`
                        }]
                    })
                });
                
                const data = await response.json();

                if (!response.ok) {
                    console.error('API error:', data.error);
                    return [{
                        advisor: 'Rachel Chen',
                        message: `Communication error: ${data.error || 'Server unavailable'}. Check that the server is running.`,
                        attachment: null
                    }];
                }

                let text = data.content[0].text;

                // Clean up response
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                try {
                    const parsed = JSON.parse(text);
                    return parsed;
                } catch (e) {
                    console.error('Failed to parse advisor response:', e);
                    console.error('Raw response:', text);
                    return [{
                        advisor: 'Rachel Chen',
                        message: 'Technical difficulty in situation room. Please rephrase your question.',
                        attachment: null
                    }];
                }

            } catch (error) {
                console.error('Situation room error:', error);
                return [{
                    advisor: 'Rachel Chen',
                    message: 'Cannot reach server. Make sure the server is running (npm start).',
                    attachment: null
                }];
            }
        }
        
        function addAdvisorMessage(type, name, content, attachment = null) {
            const console = document.getElementById('advisor-console');
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `advisor-message ${type}`;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'advisor-name';
            nameDiv.textContent = `[${name}]`;
            
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            
            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(contentDiv);
            
            // Add attachment if present
            if (attachment) {
                const docId = `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const attachDiv = document.createElement('div');
                attachDiv.style.cssText = 'margin-top: 8px; padding: 8px; background: rgba(74, 158, 255, 0.1); border-left: 2px solid #4a9eff; font-size: 10px; cursor: pointer;';
                attachDiv.innerHTML = `
                    <div style="color: #4a9eff; font-weight: bold; margin-bottom: 4px;">üìé ATTACHMENT (click to view)</div>
                    <div style="color: #6bb3ff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHTML(attachment.substring(0, 100))}...</div>
                `;
                
                attachDiv.onclick = () => openDocument(docId, name, attachment);
                
                msgDiv.appendChild(attachDiv);
                
                // Store document
                if (!gameState.documents) gameState.documents = [];
                gameState.documents.push({
                    id: docId,
                    author: name,
                    content: attachment,
                    timestamp: new Date().toISOString()
                });
                
                // Update document count
                updateDocumentCount();
            }
            
            console.appendChild(msgDiv);
            console.scrollTop = console.scrollHeight;
            
            // Keep console manageable (last 20 messages)
            while (console.children.length > 20) {
                console.removeChild(console.firstChild);
            }
        }
        
        function openDocument(docId, author, content) {
            // Create modal overlay for document viewing
            const existing = document.getElementById('document-viewer');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'document-viewer';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #001a33;
                    border: 2px solid #4a9eff;
                    padding: 20px;
                    max-width: 700px;
                    max-height: 80vh;
                    overflow-y: auto;
                    color: #ffb000;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #4a9eff;">
                        <div>
                            <div style="color: #4a9eff; font-weight: bold;">CLASSIFIED DOCUMENT</div>
                            <div style="font-size: 10px; color: #6bb3ff; margin-top: 5px;">Author: ${author}</div>
                        </div>
                        <button onclick="document.getElementById('document-viewer').remove()" style="
                            background: #1a2633;
                            border: 1px solid #4a9eff;
                            color: #ffb000;
                            padding: 5px 15px;
                            cursor: pointer;
                            font-family: 'Courier New', monospace;
                        ">CLOSE</button>
                    </div>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${escapeHTML(content)}</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                `SIMULATION TIME: ${now.toISOString().replace('T', ' ').substr(0, 19)} ZULU`;
        }
        
        function startScenario(scenario) {
            gameState.scenario = scenario;
            gameState.turn++;
            
            // Show briefing if available
            if (scenario.briefing && scenario.briefing.slides) {
                showBriefing(scenario);
            } else {
                // Fallback to old style if no briefing
                displayScenario(scenario);
            }
        }
        
        function showBriefing(scenario) {
            const overlay = document.getElementById('briefing-overlay');
            const content = document.getElementById('briefing-content');
            const title = document.getElementById('briefing-title');
            
            title.textContent = scenario.title;
            
            gameState.briefing.slides = scenario.briefing.slides;
            gameState.briefing.totalSlides = scenario.briefing.slides.length;
            gameState.briefing.currentSlide = 0;
            
            // Create slides
            content.innerHTML = scenario.briefing.slides.map((slide, index) => `
                <div class="briefing-slide ${index === 0 ? 'active' : ''}" data-slide="${index}">
                    <div class="slide-title">${slide.title}</div>
                    ${slide.content}
                </div>
            `).join('');
            
            document.getElementById('current-slide').textContent = '1';
            document.getElementById('total-slides').textContent = gameState.briefing.totalSlides;
            document.getElementById('prev-slide').disabled = true;
            document.getElementById('next-slide').disabled = false;
            document.getElementById('begin-scenario').style.display = 'none';
            
            overlay.classList.add('show');
            
            // Setup navigation
            document.getElementById('prev-slide').onclick = () => navigateBriefing(-1);
            document.getElementById('next-slide').onclick = () => navigateBriefing(1);
            document.getElementById('begin-scenario').onclick = () => closeBriefing(scenario);
        }
        
        function navigateBriefing(direction) {
            const newSlide = gameState.briefing.currentSlide + direction;
            
            if (newSlide < 0 || newSlide >= gameState.briefing.totalSlides) return;
            
            // Hide current slide
            document.querySelectorAll('.briefing-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Show new slide
            document.querySelector(`[data-slide="${newSlide}"]`).classList.add('active');
            gameState.briefing.currentSlide = newSlide;
            
            // Update UI
            document.getElementById('current-slide').textContent = newSlide + 1;
            document.getElementById('prev-slide').disabled = newSlide === 0;
            
            // Show begin button on last slide
            if (newSlide === gameState.briefing.totalSlides - 1) {
                document.getElementById('next-slide').style.display = 'none';
                document.getElementById('begin-scenario').style.display = 'inline-block';
            } else {
                document.getElementById('next-slide').style.display = 'inline-block';
                document.getElementById('begin-scenario').style.display = 'none';
            }
        }
        
        function closeBriefing(scenario) {
            document.getElementById('briefing-overlay').classList.remove('show');
            displayScenario(scenario);
            addIntel(`Briefing complete. Crisis response authorized. Standing by for your decision.`, 'critical');
        }
        
        function displayScenario(scenario) {
            document.getElementById('situation-text').innerHTML = `
                <div style="font-weight: bold; color: #ffff00; margin-bottom: 10px;">${scenario.title}</div>
                <div>${scenario.description}</div>
            `;
            
            if (gameState.commandMode) {
                // Show natural language command interface
                document.getElementById('command-interface').style.display = 'block';
                document.getElementById('options-container').style.display = 'none';
                
                // Setup command handlers
                document.getElementById('submit-command').onclick = submitPlayerCommand;
                document.getElementById('show-suggested-options').onclick = showSuggestedOptions;
                document.getElementById('approve-orders').onclick = approveOrders;
                document.getElementById('modify-orders').onclick = modifyOrders;
                document.getElementById('cancel-orders').onclick = cancelOrders;
            } else {
                // Fallback: show traditional options
                const optionsContainer = document.getElementById('options-container');
                optionsContainer.style.display = 'block';
                document.getElementById('command-interface').style.display = 'none';
                optionsContainer.innerHTML = '<div class="panel-title">RESPONSE OPTIONS</div>';
                
                scenario.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = `[${index + 1}] ${option.text}`;
                    btn.onclick = () => executeOption(option);
                    optionsContainer.appendChild(btn);
                });
            }
            
            addIntel(`New crisis detected: ${scenario.title}`, 'critical');
            
            // Initialize map for this scenario
            initializeMapForScenario(scenario);
        }
        
        // Natural Language Command Processing
        let isProcessingCommand = false;
        
        async function submitPlayerCommand() {
            if (isProcessingCommand) {
                console.log('Already processing a command, please wait...');
                return;
            }
            
            const commandInput = document.getElementById('player-command');
            const command = commandInput.value.trim();
            
            if (!command) {
                addIntel('ERROR: No command entered.', 'critical');
                return;
            }
            
            // Set processing flag
            isProcessingCommand = true;
            
            // Show processing indicator
            document.getElementById('processing-indicator').style.display = 'block';
            document.getElementById('submit-command').disabled = true;
            
            addIntel(`Processing command: "${command.substring(0, 60)}${command.length > 60 ? '...' : ''}"`, 'warning');
            
            try {
                // Send to Claude for interpretation
                const orders = await interpretCommand(command);
                
                // Hide processing indicator
                document.getElementById('processing-indicator').style.display = 'none';
                document.getElementById('submit-command').disabled = false;
                isProcessingCommand = false;
                
                // Check if clarification needed
                if (orders.clarifications_needed && orders.clarifications_needed.length > 0) {
                    addIntel(`CLARIFICATION REQUIRED: ${orders.clarifications_needed.join(' ')}`, 'warning');
                    return;
                }
                
                // Check feasibility
                if (!orders.feasibility.possible) {
                    addIntel(`ORDER REJECTED: ${orders.feasibility.issues.join(' ')}`, 'critical');
                    return;
                }
                
                // Store orders and show review
                gameState.currentOrders = orders;
                displayOrderReview(orders);
                
            } catch (error) {
                console.error('Error processing command:', error);
                addIntel(`ERROR: ${error.message || 'Failed to process command. Please try again.'}`, 'critical');
                document.getElementById('processing-indicator').style.display = 'none';
                document.getElementById('submit-command').disabled = false;
                isProcessingCommand = false;
            }
        }
        
        async function interpretCommand(command) {
            const response = await fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    messages: [{
                        role: 'user',
                        content: `You are the game master for a geopolitical crisis simulation. Parse the player's command into executable orders.

CURRENT GAME STATE:
- Scenario: ${gameState.scenario.title}
- Turn: ${gameState.turn}
- Stability: ${gameState.stability}/100
- Diplomacy: ${gameState.diplomacy}/100
- Military Readiness: ${gameState.military}/100
- Public Support: ${gameState.support}/100
- Allied Confidence: ${gameState.allies}/100
- Intelligence: ${gameState.intelligence}/100
- DEFCON: ${gameState.defcon}

SCENARIO CONTEXT:
${gameState.scenario.description}

PLAYER COMMAND:
"${command}"

Parse this into structured orders. Respond with VALID JSON only (no markdown, no code blocks, no +/- signs on numbers):
{
    "orders": [
        {
            "type": "military|diplomatic|economic|intelligence|public_statement",
            "action": "specific action description",
            "target": "who/what/where",
            "timeline": "immediate|hours|days|weeks",
            "intensity": "low|medium|high"
        }
    ],
    "predicted_effects": {
        "stability": -20,
        "diplomacy": 10,
        "military": 5,
        "support": -5,
        "allies": 15,
        "intelligence": 0
    },
    "risks": ["specific risk 1", "specific risk 2"],
    "opportunities": ["potential positive outcome 1"],
    "feasibility": {
        "possible": true,
        "issues": []
    },
    "clarifications_needed": []
}

CRITICAL: Use plain numbers without + or - prefixes. Example: "stability": 10 NOT "stability": +10

IMPORTANT RULES:
1. Be realistic - predict actual consequences
2. Allow catastrophic decisions (nukes, full mobilization) but show severe consequences
3. Flag unclear/vague commands in clarifications_needed
4. If command is gibberish or impossible, set feasibility.possible to false
5. Larger actions have larger effects (both positive and negative)
6. Consider current metrics - low military readiness limits military options`
                    }]
                })
            });
            
            const data = await response.json();
            let text = data.content[0].text;
            
            // Remove markdown code blocks if present
            text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            // Remove any + signs before numbers (common JSON formatting issue)
            text = text.replace(/:\s*\+(\d+)/g, ': $1');
            
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('JSON parse error:', e);
                console.error('Problematic JSON:', text);
                throw new Error('Failed to parse AI response. Please try a different command.');
            }
        }
        
        function displayOrderReview(orders) {
            const reviewPanel = document.getElementById('order-review');
            const detailsDiv = document.getElementById('order-details');
            
            let html = '';
            
            // Orders section
            html += '<div class="order-section"><h4>Parsed Orders</h4>';
            orders.orders.forEach((order, i) => {
                html += `<div class="order-item">
                    <strong>${i + 1}. ${order.type.toUpperCase()}:</strong> ${order.action}<br>
                    <span style="font-size: 10px; color: #6bb3ff;">
                        Target: ${order.target} | Timeline: ${order.timeline} | Intensity: ${order.intensity}
                    </span>
                </div>`;
            });
            html += '</div>';
            
            // Predicted effects
            html += '<div class="order-section"><h4>Predicted Effects</h4>';
            Object.keys(orders.predicted_effects).forEach(metric => {
                const value = orders.predicted_effects[metric];
                const color = value > 0 ? 'effect-positive' : value < 0 ? 'effect-negative' : 'effect-neutral';
                const sign = value > 0 ? '+' : '';
                html += `<div class="order-item ${color}">${metric.toUpperCase()}: ${sign}${value}</div>`;
            });
            html += '</div>';
            
            // Risks
            if (orders.risks && orders.risks.length > 0) {
                html += '<div class="order-section"><h4>Risks</h4>';
                orders.risks.forEach(risk => {
                    const severity = risk.toLowerCase().includes('catastrophic') || 
                                   risk.toLowerCase().includes('war') ||
                                   risk.toLowerCase().includes('nuclear') ? 'critical-warning' : 'risk-warning';
                    html += `<div class="${severity}">‚ö† ${risk}</div>`;
                });
                html += '</div>';
            }
            
            // Opportunities
            if (orders.opportunities && orders.opportunities.length > 0) {
                html += '<div class="order-section"><h4>Opportunities</h4>';
                orders.opportunities.forEach(opp => {
                    html += `<div class="order-item effect-positive">‚úì ${opp}</div>`;
                });
                html += '</div>';
            }
            
            detailsDiv.innerHTML = html;
            
            // Show review panel, hide command input
            reviewPanel.style.display = 'block';
            document.getElementById('command-interface').style.display = 'none';
            
            addIntel('Orders parsed and ready for review.', 'warning');
        }
        
        async function approveOrders() {
            const orders = gameState.currentOrders;
            if (!orders) return;
            
            addIntel('ORDERS APPROVED. Executing...', 'critical');
            
            // Hide review panel
            document.getElementById('order-review').style.display = 'none';
            
            // Execute orders
            await executeOrders(orders);
        }
        
        function modifyOrders() {
            // Return to command input with previous command
            document.getElementById('order-review').style.display = 'none';
            document.getElementById('command-interface').style.display = 'block';
            gameState.currentOrders = null;
            addIntel('Modify your orders and resubmit.', 'warning');
        }
        
        function cancelOrders() {
            document.getElementById('order-review').style.display = 'none';
            document.getElementById('command-interface').style.display = 'block';
            document.getElementById('player-command').value = '';
            gameState.currentOrders = null;
            addIntel('Orders cancelled.', 'warning');
        }
        
        async function showSuggestedOptions() {
            addIntel('Generating suggested response options...', 'warning');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        messages: [{
                            role: 'user',
                            content: `Suggest 3-4 response options for this crisis situation:

SCENARIO: ${gameState.scenario.title}
DESCRIPTION: ${gameState.scenario.description}
CURRENT STATE: Stability ${gameState.stability}, DEFCON ${gameState.defcon}

Provide 3-4 brief command suggestions (one line each) ranging from cautious to aggressive. Output as plain text list.`
                        }]
                    })
                });
                
                const data = await response.json();
                const suggestions = data.content[0].text;
                
                addIntel(`SUGGESTED OPTIONS:\n${suggestions}`, 'warning');
            } catch (error) {
                console.error('Error getting suggestions:', error);
                addIntel('Failed to generate suggestions.', 'critical');
            }
        }
        
        async function executeOrders(orders) {
            // Apply metric changes
            Object.keys(orders.predicted_effects).forEach(metric => {
                if (gameState[metric] !== undefined) {
                    gameState[metric] = Math.max(0, Math.min(100, 
                        gameState[metric] + orders.predicted_effects[metric]));
                }
            });
            
            // Update DEFCON
            if (gameState.stability < 30) gameState.defcon = 2;
            else if (gameState.stability < 50) gameState.defcon = 3;
            else if (gameState.stability < 70) gameState.defcon = 4;
            else gameState.defcon = 5;
            
            updateDisplay();
            
            // Visualize orders on map
            visualizeOrders(orders);
            
            // Generate adversary response
            const adversaryResponse = await generateAdversaryResponse(orders);
            addIntel(`ADVERSARY RESPONSE: ${adversaryResponse}`, 'critical');
            
            // Check for game over conditions
            setTimeout(() => checkGameStateNL(orders), 2000);
        }
        
        function visualizeOrders(orders) {
            orders.orders.forEach(order => {
                if (order.type === 'military') {
                    // Detect carrier deployments
                    if (order.action.toLowerCase().includes('carrier') && 
                        order.action.toLowerCase().includes('taiwan')) {
                        addForceMovement(21.3, -157.8, 25.0, 121.5, 'Carrier Group', '#4a9eff');
                    }
                    
                    // Detect bomber deployments
                    if (order.action.toLowerCase().includes('bomber') &&
                        order.action.toLowerCase().includes('guam')) {
                        addForceMovement(38.9, -77.0, 13.4, 144.7, 'Bomber Squadron', '#4a9eff');
                    }
                    
                    // Add threat indicator for high-intensity military actions
                    if (order.intensity === 'high') {
                        if (gameState.scenario.id === 'taiwan_strait') {
                            addThreat(25.0, 121.5, 'Military Action');
                        }
                    }
                }
            });
        }
        
        async function generateAdversaryResponse(orders) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 500,
                    messages: [{
                        role: 'user',
                        content: `You are simulating the adversary nation's response in a crisis.

SCENARIO: ${gameState.scenario.title}
PLAYER ORDERS: ${JSON.stringify(orders.orders)}
CURRENT DEFCON: ${gameState.defcon}
STABILITY: ${gameState.stability}

Generate a realistic adversary response (2-4 sentences). Consider:
- Proportional response doctrine  
- Face-saving requirements
- Domestic pressures
- Strategic calculations
- Escalation ladder

Be realistic. If player did something catastrophic (nukes, full invasion), respond accordingly.
Output plain text only, no JSON.`
                    }]
                })
            });
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        async function checkGameStateNL(orders) {
            // Check immediate loss conditions
            if (gameState.stability < 20 || gameState.support < 20) {
                endGame(false, 'Domestic instability has forced your resignation. The crisis continues without coherent leadership.');
                return;
            }
            
            if (gameState.allies < 20) {
                endGame(false, 'Alliance structure has collapsed. Isolated and vulnerable, strategic options have evaporated.');
                return;
            }
            
            // Check for catastrophic orders
            const hasCatastrophicOrder = orders.orders.some(o => 
                o.action.toLowerCase().includes('nuclear') ||
                o.action.toLowerCase().includes('nuke') ||
                (o.intensity === 'high' && o.type === 'military' && gameState.stability < 30)
            );
            
            if (hasCatastrophicOrder) {
                endGame(false, 'Your orders triggered a catastrophic escalation spiral. The crisis has erupted into open conflict with devastating consequences for all parties.');
                return;
            }
            
            // Check victory
            if (gameState.stability > 80 && gameState.allies > 70 && gameState.turn >= 3) {
                endGame(true, 'Through careful maneuvering, the crisis has been defused. Tensions remain, but catastrophe has been averted.');
                return;
            }
            
            // Generate new situation
            gameState.turn++;
            await generateNewSituation(orders);
        }
        
        async function generateNewSituation(orders) {
            addIntel('Generating next phase of crisis...', 'warning');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 300,
                        messages: [{
                            role: 'user',
                            content: `Generate the next phase of this crisis based on player actions.

SCENARIO: ${gameState.scenario.title}
PREVIOUS ORDERS: ${JSON.stringify(orders.orders)}
CURRENT STATE: Stability ${gameState.stability}, DEFCON ${gameState.defcon}, Turn ${gameState.turn}

Describe the new situation (2-3 sentences). What has developed? What new decisions does the player face?
Output plain text only.`
                        }]
                    })
                });
                
                const data = await response.json();
                const newSituation = data.content[0].text;
                
                // Update situation display
                document.getElementById('situation-text').innerHTML = `
                    <div style="font-weight: bold; color: #ffff00; margin-bottom: 10px;">TURN ${gameState.turn}: ${gameState.scenario.title}</div>
                    <div>${newSituation}</div>
                `;
                
                // Reset command interface
                document.getElementById('player-command').value = '';
                document.getElementById('command-interface').style.display = 'block';
                document.getElementById('order-review').style.display = 'none';
                gameState.currentOrders = null;
                
                addIntel(newSituation, 'warning');
                
            } catch (error) {
                console.error('Error generating new situation:', error);
                addIntel('Failed to generate next phase. Crisis continues...', 'critical');
            }
        }
        
        function initializeMapForScenario(scenario) {
            // Clear previous threats and movements
            clearMapThreats();
            clearMapMovements();
            
            // Set appropriate view for scenario
            if (scenario.id === 'taiwan_strait') {
                setTimeout(() => setLeafletView('pacific'), 500);
            } else if (scenario.id === 'arctic_resources') {
                setTimeout(() => setLeafletView('arctic'), 500);
            } else if (scenario.id === 'cyber_attack') {
                setTimeout(() => setLeafletView('world'), 500);
            }
        }
        
        function executeOption(option) {
            // Apply effects
            Object.keys(option.effects).forEach(key => {
                if (gameState[key] !== undefined) {
                    gameState[key] = Math.max(0, Math.min(100, gameState[key] + option.effects[key]));
                }
            });
            
            // Update DEFCON based on stability
            if (gameState.stability < 30) gameState.defcon = 2;
            else if (gameState.stability < 50) gameState.defcon = 3;
            else if (gameState.stability < 70) gameState.defcon = 4;
            else gameState.defcon = 5;
            
            updateDisplay();
            addIntel(option.intel, gameState.stability < 40 ? 'critical' : 'warning');
            
            // Update map based on decision
            updateMapForDecision(option);
            
            // Check win/loss conditions
            setTimeout(() => checkGameState(option.nextPhase), 1500);
        }
        
        function updateMapForDecision(option) {
            const scenario = gameState.scenario;
            
            if (!scenario) return;
            
            // Taiwan Strait Crisis
            if (scenario.id === 'taiwan_strait') {
                if (option.text.includes('carrier group')) {
                    // Show carrier movement from Pearl Harbor to Taiwan
                    addForceMovement(21.3, -157.8, 25.0, 121.5, 'USS Reagan CSG', '#4a9eff');
                    addIntel('SIGINT: Carrier Strike Group Reagan departing Pearl Harbor. ETA 36 hours.', 'warning');
                } else if (option.text.includes('sanctions')) {
                    // Add economic pressure indicators
                    addThreat(39.9, 116.4, 'Economic Pressure');
                } else if (option.text.includes('multilateral')) {
                    // Show allied coordination
                    addForceMovement(35.6, 139.7, 25.0, 121.5, 'JSDF Alert', '#4a9eff');
                    addForceMovement(37.5, 127.0, 25.0, 121.5, 'ROK Support', '#4a9eff');
                }
                
                // Always show PLA activity
                if (gameState.turn === 1) {
                    addThreat(25.0, 121.5, 'PLA Exercise');
                }
            }
            
            // Arctic Crisis
            if (scenario.id === 'arctic_resources') {
                if (option.text.includes('forward operating bases')) {
                    addForceMovement(51.5, -0.1, 75.0, 0.0, 'NATO Arctic Deploy', '#4a9eff');
                    addIntel('NATO forces deploying to Arctic installations.', 'warning');
                } else if (option.text.includes('intelligence operations')) {
                    addThreat(75.0, 0.0, 'ISR Active');
                }
                
                // Show Russian presence
                if (gameState.turn === 1) {
                    addThreat(75.0, 0.0, 'Russian Installation');
                }
            }
            
            // Cyber Attack
            if (scenario.id === 'cyber_attack') {
                if (option.text.includes('counter-cyber')) {
                    addThreat(55.7, 37.6, 'Cyber Ops');
                    addIntel('Cyber Command executing response operations.', 'critical');
                } else if (option.text.includes('Article 5')) {
                    // Show NATO activation
                    addForceMovement(51.5, -0.1, 38.9, -77.0, 'NATO Alert', '#4a9eff');
                }
                
                // Show attack origin
                if (gameState.turn === 1) {
                    addThreat(55.7, 37.6, 'Attack Source');
                }
            }
        }
        
        function checkGameState(nextPhase) {
            if (gameState.stability < 20 || gameState.support < 20) {
                endGame(false, 'Domestic instability has forced your resignation. The crisis continues without coherent leadership.');
                return;
            }
            
            if (gameState.allies < 20) {
                endGame(false, 'Alliance structure has collapsed. Isolated and vulnerable, strategic options have evaporated.');
                return;
            }
            
            if (gameState.stability > 80 && gameState.allies > 70 && gameState.turn >= 3) {
                endGame(true, 'Through careful maneuvering, the crisis has been defused. Tensions remain, but catastrophe has been averted.');
                return;
            }
            
            // Continue with consequences
            generateConsequence(nextPhase);
        }
        
        function generateConsequence(phase) {
            const consequences = {
                escalation: [
                    'Enemy forces respond with their own deployments. Regional tension increases significantly.',
                    'Allied partners express concern about escalation trajectory. Intelligence indicates mobilization.',
                    'International media reports crisis as "brink of conflict." Markets volatile.'
                ],
                negotiation: [
                    'Backchannels produce preliminary framework. Details remain contentious.',
                    'Hardliners on both sides criticize negotiation approach as weakness.',
                    'Intelligence suggests enemy buying time to consolidate position.'
                ],
                coalition: [
                    'Partners agree to coordinate but disagree on specific actions. Unity fragile.',
                    'Joint statement released. Impact on adversary unclear.',
                    'Smaller allies request security guarantees before full commitment.'
                ],
                economic_war: [
                    'Sanctions begin to bite but also impact allied economies. Public pressure mounting.',
                    'Counter-sanctions announced. Global supply chains disrupted.',
                    'Economic warfare opens new fronts. Financial markets react negatively.'
                ]
            };
            
            const options = consequences[phase] || consequences.escalation;
            const consequence = options[Math.floor(Math.random() * options.length)];
            
            addIntel(consequence, 'warning');
            
            // Generate follow-up scenario
            setTimeout(() => {
                if (gameState.turn < 5 && !gameState.gameOver) {
                    generateFollowUp(phase);
                }
            }, 2000);
        }
        
        function generateFollowUp(phase) {
            const followUps = {
                escalation: {
                    description: 'Enemy forces continue buildup. Your military commanders request authorization for pre-emptive positioning. Allies watching closely.',
                    options: [
                        {
                            text: 'Authorize military positioning while pursuing de-escalation',
                            effects: {stability: -5, military: +10, diplomacy: +5, allies: +5},
                            intel: 'Forces positioned. Diplomatic channels remain open. Tense equilibrium.',
                            nextPhase: 'standoff'
                        },
                        {
                            text: 'Pull back and propose crisis resolution mechanism',
                            effects: {stability: +10, military: -15, diplomacy: +15, support: -10},
                            intel: 'Withdrawal announced. Enemy claims victory. Resolution talks scheduled.',
                            nextPhase: 'negotiation'
                        }
                    ]
                },
                negotiation: {
                    description: 'Negotiations stall on key issues. Hardliners gaining influence. Opportunity for breakthrough or collapse.',
                    options: [
                        {
                            text: 'Offer significant concessions to break deadlock',
                            effects: {stability: +15, diplomacy: +10, support: -15, allies: -10},
                            intel: 'Concessions accepted. Agreement in sight. Domestic backlash building.',
                            nextPhase: 'resolution'
                        },
                        {
                            text: 'Hold firm on core demands',
                            effects: {stability: -10, support: +10, diplomacy: -10, military: +5},
                            intel: 'Negotiations suspended. Enemy issues ultimatum. Countdown initiated.',
                            nextPhase: 'ultimatum'
                        }
                    ]
                }
            };
            
            const followUp = followUps[phase] || followUps.escalation;
            
            document.getElementById('situation-text').innerHTML = `
                <div style="font-weight: bold; color: #ffaa00; margin-bottom: 10px;">SITUATION DEVELOPMENT</div>
                <div>${followUp.description}</div>
            `;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '<div class="panel-title">RESPONSE OPTIONS</div>';
            
            followUp.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `[${index + 1}] ${option.text}`;
                btn.onclick = () => executeOption(option);
                optionsContainer.appendChild(btn);
            });
        }
        
        function updateDisplay() {
            // Update values
            document.getElementById('stability').textContent = gameState.stability;
            document.getElementById('diplomacy').textContent = gameState.diplomacy;
            document.getElementById('military').textContent = gameState.military;
            document.getElementById('support').textContent = gameState.support;
            document.getElementById('allies').textContent = gameState.allies;
            document.getElementById('intelligence').textContent = gameState.intelligence;
            
            // Update bars
            document.getElementById('stability-bar').style.width = gameState.stability + '%';
            document.getElementById('diplomacy-bar').style.width = gameState.diplomacy + '%';
            document.getElementById('military-bar').style.width = gameState.military + '%';
            document.getElementById('support-bar').style.width = gameState.support + '%';
            document.getElementById('allies-bar').style.width = gameState.allies + '%';
            document.getElementById('intelligence-bar').style.width = gameState.intelligence + '%';
            
            // Update DEFCON
            const defconEl = document.getElementById('crisis-level');
            defconEl.textContent = `DEFCON ${gameState.defcon}`;
            defconEl.className = `crisis-level level-${6 - gameState.defcon}`;
        }
        
        function addIntel(message, level = '') {
            const feed = document.getElementById('intel-feed');
            const item = document.createElement('div');
            item.className = `intel-item ${level}`;
            
            const timestamp = new Date().toISOString().substr(11, 8);
            item.innerHTML = `
                <div class="intel-timestamp">[${timestamp}Z]</div>
                <div>${message}</div>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep feed manageable
            while (feed.children.length > 15) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        function endGame(victory, message) {
            gameState.gameOver = true;
            const gameOver = document.getElementById('game-over');
            document.getElementById('game-over-title').textContent = 
                victory ? 'CRISIS RESOLVED' : 'SCENARIO FAILURE';
            document.getElementById('game-over-text').textContent = message;
            gameOver.classList.add('show');
            
            addIntel(message, victory ? '' : 'critical');
        }
        
        // Start the game
        initGame();
    </script>
</body>
</html>